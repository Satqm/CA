Let me help you fix both issues: the error loading targets and adding the mark complete/actual hours functionality.

Problem 1: Error Loading Targets

The error is likely due to the Firestore query or timestamp handling. Let me fix the loadTargets() function:

```javascript
function loadTargets() {
    if (!currentUser) return;
    
    console.log("Loading targets for user:", currentUser.uid);
    
    const targetsList = document.getElementById('targets-list');
    targetsList.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Loading targets...</h3></div>';
    
    db.collection('targets')
        .where('userId', '==', currentUser.uid)
        .get()
        .then((querySnapshot) => {
            console.log("Targets found:", querySnapshot.size);
            userTargets = [];
            
            if (querySnapshot.empty) {
                targetsList.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-plus"></i><h3>No targets set</h3><p>Add your first target to get started!</p></div>';
                updatePlanningStats([]);
                return;
            }
            
            let targetsHTML = '';
            const today = new Date().toDateString();
            const todayTargets = [];
            
            querySnapshot.forEach((doc) => {
                const target = doc.data();
                target.id = doc.id;
                userTargets.push(target);
                
                // Handle Firestore timestamp
                let targetDate;
                if (target.targetDate && target.targetDate.toDate) {
                    targetDate = target.targetDate.toDate();
                } else if (target.targetDate && target.targetDate.seconds) {
                    targetDate = new Date(target.targetDate.seconds * 1000);
                } else {
                    targetDate = new Date();
                }
                
                const isToday = targetDate.toDateString() === today;
                
                if (isToday) {
                    todayTargets.push(target);
                }
                
                const subjectName = getSubjectName(target.subject);
                const targetTypeName = getTargetTypeName(target.targetType);
                
                targetsHTML += `
                <div class="target-item" data-id="${doc.id}">
                    <div class="target-header">
                        <div class="target-title">${target.topic}</div>
                        <span class="target-subject">${subjectName}</span>
                    </div>
                    <div class="target-details">
                        <div><strong>Type:</strong> ${targetTypeName}</div>
                        <div><strong>Date:</strong> ${formatDate(targetDate)}</div>
                        ${target.subtopic ? `<div><strong>Subtopic:</strong> ${target.subtopic}</div>` : ''}
                    </div>
                    <div class="target-time">
                        <div class="target-planned">
                            <strong>Planned:</strong> ${target.plannedHours} hrs
                        </div>
                        <div class="target-actual">
                            <strong>Actual:</strong>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" 
                                       class="actual-hours-input"
                                       value="${target.actualHours || 0}"
                                       min="0"
                                       max="24"
                                       step="0.5"
                                       data-id="${doc.id}"
                                       style="width: 80px; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                                <span>hrs</span>
                                <button class="save-hours-btn" data-id="${doc.id}" style="padding: 8px 15px; background: var(--secondary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="target-progress">
                        <div class="progress-bar" style="height: 10px; background: #e9ecef; border-radius: 5px; margin: 15px 0; overflow: hidden;">
                            <div class="progress-fill" style="height: 100%; background: var(${target.completed ? '--success' : '--secondary'}); width: ${Math.min(100, ((target.actualHours || 0) / target.plannedHours) * 100)}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--gray);">
                            <span>${target.completed ? '✓ Completed' : 'In Progress'}</span>
                            <span>${target.actualHours || 0}/${target.plannedHours} hrs</span>
                        </div>
                    </div>
                    ${target.description ? `<div class="target-description" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: var(--gray);">${target.description}</div>` : ''}
                    <div class="target-actions" style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="mark-complete-btn" data-id="${doc.id}" style="padding: 8px 16px; background: ${target.completed ? '#27ae60' : 'var(--success)'}; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">
                            <i class="fas fa-check"></i> ${target.completed ? 'Completed' : 'Mark Complete'}
                        </button>
                        <button class="add-remark-btn" data-id="${doc.id}" style="padding: 8px 16px; background: var(--warning); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">
                            <i class="fas fa-comment"></i> Add Remark
                        </button>
                        <button class="delete-target-btn" data-id="${doc.id}" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>`;
            });
            
            targetsList.innerHTML = targetsHTML;
            updatePlanningStats(todayTargets);
            
            // Add event listeners
            addTargetEventListeners();
            
        })
        .catch((error) => {
            console.error("Error loading targets:", error);
            targetsList.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading targets</h3><p>${error.message}</p></div>`;
        });
}
```

Add Helper Functions:

```javascript
function getTargetTypeName(type) {
    const typeMap = {
        'daily': 'Daily Target',
        'weekly': 'Weekly Target',
        'monthly': 'Monthly Target'
    };
    return typeMap[type] || type;
}

function addTargetEventListeners() {
    // Save hours buttons
    document.querySelectorAll('.save-hours-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-id');
            const input = document.querySelector(`.actual-hours-input[data-id="${targetId}"]`);
            const actualHours = parseFloat(input.value) || 0;
            updateTargetActualHours(targetId, actualHours);
        });
    });
    
    // Mark complete buttons
    document.querySelectorAll('.mark-complete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-id');
            markTargetComplete(targetId);
        });
    });
    
    // Add remark buttons
    document.querySelectorAll('.add-remark-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-id');
            addRemarkToTarget(targetId);
        });
    });
    
    // Delete buttons
    document.querySelectorAll('.delete-target-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-id');
            deleteTarget(targetId);
        });
    });
    
    // Actual hours input change
    document.querySelectorAll('.actual-hours-input').forEach(input => {
        input.addEventListener('change', function() {
            const targetId = this.getAttribute('data-id');
            const actualHours = parseFloat(this.value) || 0;
            // Auto-save when user changes the value and clicks away
            updateTargetActualHours(targetId, actualHours);
        });
    });
}
```

Update the updateTargetActualHours() function:

```javascript
function updateTargetActualHours(targetId, actualHours) {
    if (!currentUser) return;
    
    console.log("Updating target:", targetId, "with hours:", actualHours);
    
    const target = userTargets.find(t => t.id === targetId);
    if (!target) return;
    
    // Calculate completion percentage
    const plannedHours = target.plannedHours || 1;
    const percentage = Math.min(100, (actualHours / plannedHours) * 100);
    const completed = percentage >= 100; // Mark as completed if reached or exceeded planned hours
    
    db.collection('targets').doc(targetId).update({
        actualHours: actualHours,
        completed: completed,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        // Update local data
        target.actualHours = actualHours;
        target.completed = completed;
        
        // Update UI immediately
        const targetElement = document.querySelector(`.target-item[data-id="${targetId}"]`);
        if (targetElement) {
            // Update progress bar
            const progressFill = targetElement.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
                progressFill.style.backgroundColor = completed ? 'var(--success)' : 'var(--secondary)';
            }
            
            // Update status text
            const statusSpan = targetElement.querySelector('.target-progress span:first-child');
            if (statusSpan) {
                statusSpan.textContent = completed ? '✓ Completed' : 'In Progress';
            }
            
            // Update hours text
            const hoursSpan = targetElement.querySelector('.target-progress span:last-child');
            if (hoursSpan) {
                hoursSpan.textContent = `${actualHours}/${plannedHours} hrs`;
            }
            
            // Update button
            const completeBtn = targetElement.querySelector('.mark-complete-btn');
            if (completeBtn) {
                completeBtn.innerHTML = `<i class="fas fa-check"></i> ${completed ? 'Completed' : 'Mark Complete'}`;
                completeBtn.style.backgroundColor = completed ? '#27ae60' : 'var(--success)';
            }
        }
        
        showToast('Hours updated successfully!', 'success');
        
        // Update dashboard stats
        updateDashboard();
        
        // Update planning stats
        const today = new Date().toDateString();
        const todayTargets = userTargets.filter(t => {
            let targetDate;
            if (t.targetDate && t.targetDate.toDate) {
                targetDate = t.targetDate.toDate();
            } else if (t.targetDate && t.targetDate.seconds) {
                targetDate = new Date(t.targetDate.seconds * 1000);
            } else {
                targetDate = new Date();
            }
            return targetDate.toDateString() === today;
        });
        updatePlanningStats(todayTargets);
    })
    .catch((error) => {
        console.error("Error updating target:", error);
        showToast('Error updating target: ' + error.message, 'error');
    });
}
```

Add Remark Functionality:

```javascript
function addRemarkToTarget(targetId) {
    const target = userTargets.find(t => t.id === targetId);
    if (!target) return;
    
    const remark = prompt(`Add a remark for "${target.topic}":\n(Current: ${target.remark || 'No remark'})`, target.remark || '');
    
    if (remark !== null) {
        db.collection('targets').doc(targetId).update({
            remark: remark,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            target.remark = remark;
            showToast('Remark added successfully!', 'success');
            
            // Refresh the target display
            loadTargets();
        })
        .catch((error) => {
            console.error("Error adding remark:", error);
            showToast('Error adding remark: ' + error.message, 'error');
        });
    }
}
```

Mark Complete Function:

```javascript
function markTargetComplete(targetId) {
    const target = userTargets.find(t => t.id === targetId);
    if (!target) return;
    
    if (target.completed) {
        // If already completed, unmark it
        updateTargetActualHours(targetId, 0);
    } else {
        // Mark as complete by setting actual hours to planned hours
        updateTargetActualHours(targetId, target.plannedHours);
    }
}
```

Delete Target Function:

```javascript
function deleteTarget(targetId) {
    if (!confirm('Are you sure you want to delete this target?')) return;
    
    db.collection('targets').doc(targetId).delete()
        .then(() => {
            // Remove from local data
            userTargets = userTargets.filter(t => t.id !== targetId);
            
            // Remove from DOM
            const targetElement = document.querySelector(`.target-item[data-id="${targetId}"]`);
            if (targetElement) {
                targetElement.remove();
            }
            
            showToast('Target deleted successfully!', 'success');
            
            // Update stats
            const today = new Date().toDateString();
            const todayTargets = userTargets.filter(t => {
                let targetDate;
                if (t.targetDate && t.targetDate.toDate) {
                    targetDate = t.targetDate.toDate();
                } else if (t.targetDate && t.targetDate.seconds) {
                    targetDate = new Date(t.targetDate.seconds * 1000);
                } else {
                    targetDate = new Date();
                }
                return targetDate.toDateString() === today;
            });
            updatePlanningStats(todayTargets);
        })
        .catch((error) => {
            console.error("Error deleting target:", error);
            showToast('Error deleting target: ' + error.message, 'error');
        });
}
```

Update Planning Stats Function:

```javascript
function updatePlanningStats(todayTargets) {
    const totalTargets = todayTargets.length;
    const completedTargets = todayTargets.filter(t => t.completed).length;
    const totalPlannedHours = todayTargets.reduce((sum, t) => sum + (t.plannedHours || 0), 0);
    const totalActualHours = todayTargets.reduce((sum, t) => sum + (t.actualHours || 0), 0);
    
    document.getElementById('today-targets').textContent = totalTargets;
    document.getElementById('today-completed').textContent = completedTargets;
    
    // Add more stats if needed
    const statsContainer = document.querySelector('.planning-stats');
    if (statsContainer && !statsContainer.querySelector('#today-hours')) {
        statsContainer.innerHTML += `
            <div class="planning-stat">
                <div class="value" id="today-planned">${totalPlannedHours}</div>
                <div class="label">Planned Hours</div>
            </div>
            <div class="planning-stat">
                <div class="value" id="today-actual">${totalActualHours}</div>
                <div class="label">Actual Hours</div>
            </div>
        `;
    } else if (statsContainer) {
        document.getElementById('today-planned').textContent = totalPlannedHours;
        document.getElementById('today-actual').textContent = totalActualHours;
    }
}
```

Updated Firestore Rules (just in case):

Make sure your Firestore rules allow the updates:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /userProgress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /studyPlans/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /videos/{videoId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
                    request.auth.uid == resource.data.addedBy;
    }
    
    match /resources/{resourceId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
                    request.auth.uid == resource.data.addedBy;
    }
    
    match /targets/{targetId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
  }
}
```

Key Features Now Working:

1. Targets will load and display with proper error handling
2. Actual hours input with Save button for each target
3. Progress bar showing completion percentage
4. Mark Complete button - sets actual hours to planned hours
5. Add Remark button - adds notes/remarks to targets
6. Delete button - removes targets
7. Auto-save when changing actual hours input
8. Real-time UI updates without page refresh
9. Planning statistics showing today's targets, completed, and hours

The planning section now has full functionality! Users can:

· See all their targets with progress bars
· Update actual hours spent
· Mark targets as complete
· Add remarks/notes
· Delete targets
· See statistics about today's progress
